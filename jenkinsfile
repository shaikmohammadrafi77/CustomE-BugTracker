pipeline {
  agent any

  environment {
    APP_IP = '13.127.137.234'
    APP_USER = 'ec2-user'
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/shaikmohammadrafi77/CustomE-BugTracker.git'
      }
    }

    stage('Build') {
      steps {
        sh 'python3 -m pip install --upgrade pip'
        sh 'python3 -m pip install -r requirements.txt'
      }
    }

    stage('Test') {
      steps {
        sh 'pytest'
      }
    }

    stage('Deploy') {
      steps {
        sshagent (credentials: ['ec2_key']) {
          sh """
            scp -o StrictHostKeyChecking=no -r . ${APP_USER}@${APP_IP}:/home/${APP_USER}/app_temp
            ssh -o StrictHostKeyChecking=no ${APP_USER}@${APP_IP} "
              sudo mv /home/${APP_USER}/app_temp /home/${APP_USER}/app
              cd /home/${APP_USER}/app
              chmod +x userdata.sh || true
              ./userdata.sh || true
              nohup python3 run.py > app.log 2>&1 &
            "
          """
        }
      }
    }
  }

  post {
    success { echo '✅ CI/CD pipeline finished successfully' }
    failure { echo '❌ CI/CD pipeline failed — check logs' }
  }
}
